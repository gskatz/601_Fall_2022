{
  "hash": "5a6c3ccffa417451e39b6908afb47dea",
  "result": {
    "markdown": "---\ntitle: \"Challenge 3\"\nauthor: \"Nikita Masanagi\"\ndesription: \"Tidy Data: Pivoting\"\ndate: \"09/17/2022\"\nformat:\n  html:\n    toc: true\n    code-fold: true\n    code-copy: true\n    code-tools: true\ncategories:\n  - challenge_3\n  - usa_households\n\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n\nknitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)\n```\n:::\n\n\n## Challenge Overview\n\nToday's challenge is to:\n\n1.  read in a data set, and describe the data set using both words and any supporting information (e.g., tables, etc)\n2.  identify what needs to be done to tidy the current data\n3.  anticipate the shape of pivoted data\n4.  pivot the data into tidy format using `pivot_longer`\n\n## Read in data\n\nThe first three rows have information regarding the data in this file. This data is provides the household incomes of various races throughout the years from 1967-2019. The percentage distribution (out of 100) for different ranges in income, along with the median and mean income was also in the given dataset. There are 12 categories of the races. There are some overlaps between these categories as well (“All Races” category) and all the years are not present for some of the races.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Reading in the USA Households dataset\n# Removing the total column as information is redundant\nh_income <- read_excel(\"_data/USA Households by Total Money Income, Race, and Hispanic Origin of Householder 1967 to 2019.xlsx\",\n         skip=5, n_max = 351, col_names=c(\"year\", \"hnumber\", \"total\",\"level1\", \"level2\",\n                                          \"level3\",\"level4\",\"level5\",\"level6\",\"level7\",\"level8\",\n                                          \"level9\",\"median_income\",\"median_error\",\n                                    \"mean_income\",\"mean_error\") ) %>% select(-total)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in read_excel(\"_data/USA Households by Total Money Income, Race, and Hispanic Origin of Householder 1967 to 2019.xlsx\", : could not find function \"read_excel\"\n```\n:::\n\n```{.r .cell-code}\nincome_vals <- c(\"level1\",\"level2\",\"level3\",\"level4\",\"level5\",\"level6\",\"level7\",\"level8\",\"level9\")\nincome_levels <- c(\"Under $15000\",\"$15000 to $29000\",\"$25000 to $34999\",\"$35000 to $49999\",\"$50000 to $74999\",\"$75000 to $99999\",\"$100000 to $149999\",\"1500000 to $199999\",\"$200000 and over\")\nh_income\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in eval(expr, envir, enclos): object 'h_income' not found\n```\n:::\n:::\n\n\n### Briefly describe the data\n\nIn the above data, we have the necessary household income values for various throughout different years. The levels of the income range have also been named accordingly and the mapping is found in the vector ‘income_levels’. \n\nThere is a need to pivot this data in order to get the the races corresponding to each year. Currently, the races are only present atop each section of data. Pivoting will help in grouping the data and making calculations easier against different categories of race.\n\n\n\n## Cleaning the data\n\n We can add the category of race as a new column for all the rows. Here, we get all the categories of race. There are some numeric characters also present in them which can be removed.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(stringr)\n\n# Creating a new column named race_cat + removing the rows with string only \n# race category\nh_income_race <- h_income %>% mutate(race_cat = case_when(\n  str_detect(year, \"[A-Za-z]\") ~ year,\n  TRUE ~ NA_character_\n)) %>% fill(race_cat) %>% filter(!str_detect(year, \"[A-Za-z]\"))\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in mutate(., race_cat = case_when(str_detect(year, \"[A-Za-z]\") ~ : object 'h_income' not found\n```\n:::\n\n```{.r .cell-code}\n# Removing the notes number from the year and race_cat columns\n\nh_income_race <- h_income_race %>% separate(year, c(\"year\",\"notes\"), sep = \" \") %>% select(-notes)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in separate(., year, c(\"year\", \"notes\"), sep = \" \"): object 'h_income_race' not found\n```\n:::\n\n```{.r .cell-code}\nh_income_race$race_cat <- gsub('[0-9]+', '', h_income_race$race_cat)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in is.factor(x): object 'h_income_race' not found\n```\n:::\n\n```{.r .cell-code}\n# Detected some non numeric characters in the numeric fields. So need to remove them\nh_income_race <- h_income_race %>%\n    mutate(across(c(hnumber, starts_with(\"level\"), starts_with(\"me\")),~ replace(.,str_detect(., \"[A-Za-z]\"), NA))) %>% mutate_at(vars(hnumber, starts_with(\"me\"), starts_with(\"level\")), as.numeric)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in mutate(., across(c(hnumber, starts_with(\"level\"), starts_with(\"me\")), : object 'h_income_race' not found\n```\n:::\n\n```{.r .cell-code}\nclass(h_income_race$hnumber)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in eval(expr, envir, enclos): object 'h_income_race' not found\n```\n:::\n:::\n\n\n\n## Pivot the Data\n\nThe data needs to be pivoted such that for each race category the household income numbers are viewed under each year (as columns) this can help summarise the data for each race. However with the current data we can see that there are many overlapping instances of the categories of races. It will be easier to group them into a larger group for further analysis and pivoting. The data is then summarised across the numeric columns by calculating their sum.\n\nThe data is then pivoted into a wider form, wherein the rows are transformed into columns. This new table only consists of the household income numbers for the different categories of race across various years from 2000-2019. This data can further be used to find the mean or median for a particular year and particular race category.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Further clean the data\nclean_h_income <- h_income_race %>% mutate(\n  gp_race_cat = case_when(\n    grepl(\"BLACK\", race_cat, fixed=TRUE) ~ \"grp_black\",\n    grepl(\"ASIAN\", race_cat, fixed=TRUE) ~ \"grp_asian\",\n    grepl(\"WHITE\", race_cat, fixed=TRUE) ~ \"grp_white\",\n    grepl(\"HISPANIC\", race_cat, fixed=TRUE) & !grepl(\"NOT\", race_cat, fixed=TRUE) ~ \"grp_hisp\",\n    grepl(\"ALL\", race_cat, fixed=TRUE) ~ \"grp_all\",\n  )\n) %>% filter(!is.na(gp_race_cat)) %>%\n  group_by(year, gp_race_cat) %>% \n  summarise(across(c(starts_with(\"level\"),starts_with(\"me\"),\n                     \"hnumber\"), \n                   ~sum(.x, na.rm=TRUE)))\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in mutate(., gp_race_cat = case_when(grepl(\"BLACK\", race_cat, fixed = TRUE) ~ : object 'h_income_race' not found\n```\n:::\n\n```{.r .cell-code}\nhead(clean_h_income)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in head(clean_h_income): object 'clean_h_income' not found\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Pivot the data only containing household income numbers\nclean_h_income %>% select(gp_race_cat, hnumber, year) %>%\n  pivot_wider(values_from=hnumber, names_from=year) %>% select(c(gp_race_cat, starts_with(\"20\")))\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in select(., gp_race_cat, hnumber, year): object 'clean_h_income' not found\n```\n:::\n:::\n\n\nThe cleaned data can also be pivoted by length, wherein there are more rows and lesser number of columns. Here, we can expand the income distribution range for different races through the years.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Pivoting the data\npivot_data <- clean_h_income %>% ungroup() %>%\n  select(c(year, gp_race_cat, starts_with(\"level\"),hnumber,)) %>%\n  pivot_longer(cols=starts_with(\"level\"), names_to=\"IncomeRange\", values_to=\"percent\")\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in ungroup(.): object 'clean_h_income' not found\n```\n:::\n\n```{.r .cell-code}\n# Replacing the income range levels\npivot_data$IncomeRange <- str_replace_all(pivot_data$IncomeRange, setNames(income_levels,income_vals))\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in stri_replace_all_regex(string, pattern, fix_replacement(replacement), : object 'pivot_data' not found\n```\n:::\n\n```{.r .cell-code}\n# Calculating the number of household incomes for each income range distribution\npivot_data_longer <- pivot_data %>% mutate(\n  range_household_number = round((hnumber*percent)/100)\n)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in mutate(., range_household_number = round((hnumber * percent)/100)): object 'pivot_data' not found\n```\n:::\n\n```{.r .cell-code}\npivot_data_longer\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in eval(expr, envir, enclos): object 'pivot_data_longer' not found\n```\n:::\n:::\n\nFrom this table we can see that the data has been pivoted and increased in length, wherein for each income range, it’s percentage distribution and corresponding household income level for the different races across different years is present.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npivot_data_longer %>% \n  group_by(IncomeRange, year) %>%\n  summarise(across(c(range_household_number),~sum(.x, na.rm=TRUE))) %>% \n  arrange(desc(range_household_number))\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in group_by(., IncomeRange, year): object 'pivot_data_longer' not found\n```\n:::\n:::\n\n\nThis data can be further grouped by income range and year and then arranged in descending order by the range_household_number. This can tell us the income range and the year for which the household income numbers were the highest or the lowest.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}